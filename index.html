<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>TenRizoto</title>
  <style>
    body { font-family: Arial, sans-serif; line-height: 1.6; margin: 20px; }
    h1, h2 { color: #cc3366; }
    #articles-list li { margin-bottom: 20px; }
    .prefix { color: #555; font-style: italic; }
    .date { font-size: 0.9em; color: #888; }
    #article-section a { display: inline-block; margin-top: 20px; text-decoration: none; color: #cc3366; }
    #load-more { padding: 8px 14px; border: none; background:#cc3366; color:#fff; border-radius:6px; cursor:pointer; }
    #load-more[disabled]{opacity:0.6;cursor:default;}
  </style>
</head>
<body>
  <h1>Blog</h1>

  <section id="articles-section">
    <ul id="articles-list"></ul>
    <button id="load-more" style="display:none;">Načíst další</button>
  </section>

  <section id="article-section" style="display:none;">
    <div id="article-content"></div>
    <a href="/">← Zpět na seznam článků</a>
  </section>

  <script>
/* ====== Nastavení ====== */
const API_KEY = "iR0SFubwR8Z9WmdYD0gnkODNxTsC6amBlN6X4jMtoTjM1Z8Zyw";
const BLOG_NAME = "tenrizoto";
const PREFIX_LENGTH = 200; 
const LIMIT = 20;
/* ======================= */

let offset = 0;
let allLoaded = false;

function getQueryParam(name) {
  return new URLSearchParams(window.location.search).get(name);
}

// vrátí nějaký text i když není body
function getPostText(post) {
  const raw = post.body ?? post.caption ?? post.summary ?? post.text ?? post.description ?? "";
  return String(raw).replace(/<[^>]*>?/gm, '');
}

async function fetchArticlesBatch() {
  const url = `https://api.tumblr.com/v2/blog/${BLOG_NAME}.tumblr.com/posts?api_key=${API_KEY}&limit=${LIMIT}&offset=${offset}&type=all`;
  const res = await fetch(url);
  if (!res.ok) throw new Error("Chyba API: " + res.status);
  const data = await res.json();
  return data.response.posts || [];
}

async function showArticles(initial = false) {
  const list = document.getElementById("articles-list");
  const loadBtn = document.getElementById("load-more");

  if (initial) {
    list.innerHTML = "";
    offset = 0;
    allLoaded = false;
    loadBtn.style.display = "none";
  }

  const posts = await fetchArticlesBatch();
  if (!posts.length) {
    allLoaded = true;
    loadBtn.style.display = "none";
    return;
  }

  posts.forEach(post => {
    const li = document.createElement("li");
    const title = post.title || (post.summary ? post.summary.substring(0, 50) : "Bez názvu");
    const date = post.date ? new Date(post.date).toLocaleDateString() : "";
    const raw = getPostText(post);
    const prefix = raw.substring(0, PREFIX_LENGTH);
    const id = post.id; // vždy unikátní

    li.innerHTML = `
      <a href="?article=${id}">${title}</a>
      <span class="date">${date}</span>
      <br>
      <p class="prefix">${prefix}${raw.length > PREFIX_LENGTH ? "…" : ""}</p>
    `;
    list.appendChild(li);
  });

  offset += posts.length;

  if (posts.length < LIMIT) {
    allLoaded = true;
    loadBtn.style.display = "none";
  } else {
    loadBtn.style.display = "inline-block";
    loadBtn.disabled = false;
  }
}

async function showArticle(id) {
  const url = `https://api.tumblr.com/v2/blog/${BLOG_NAME}.tumblr.com/posts?id=${id}&api_key=${API_KEY}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error("Chyba API: " + res.status);
  const data = await res.json();
  const post = data.response.posts[0];
  if (!post) return;

  document.getElementById("articles-section").style.display = "none";
  const container = document.getElementById("article-content");
  const bodyHTML = post.body ?? post.caption ?? post.description ?? "";
  container.innerHTML = `
    <h2>${post.title ?? ""}</h2>
    <span class="date">${post.date ? new Date(post.date).toLocaleDateString() : ""}</span>
    <div>${bodyHTML}</div>
  `;
  document.getElementById("article-section").style.display = "block";
}

/* Init */
const slug = getQueryParam("article");
const loadBtnEl = document.getElementById("load-more");

if (loadBtnEl) {
  loadBtnEl.addEventListener("click", () => {
    if (!allLoaded) {
      loadBtnEl.disabled = true;
      showArticles();
    }
  });
}

if (slug) {
  showArticle(slug);
} else {
  showArticles(true);
}
  </script>
</body>
</html>
